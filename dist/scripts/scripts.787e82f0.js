"use strict";function AuthService(a,b,c,d,e){var f=new Firebase(d),g=b(f);this.isLoggedIn=function(){return null!==c.getAuthData()},this.logIn=function(b){return g.$authWithPassword({email:b.email,password:b.password}).then(function(b){c.setAuthData(b);var d=e.getUserInfo(b.uid);return d.then(function(a){c.setUserInfo(a)}),a.resolve(b)},function(b){return a.reject(b)})},this.logOut=function(){g.$unauth(),c.destroy()},this.singIn=function(b){var c=this;return g.$createUser({email:b.email,password:b.password}).then(function(a){return console.log("Logged in as:",a.uid),c.logIn(b)})["catch"](function(b){return a.reject(b)})}}function sessionService(a,b){this._authData=JSON.parse(b.getItem("session.authData")),this._userInfo=JSON.parse(b.getItem("session.userInfo")),this.getAuthData=function(){return this._authData},this.setAuthData=function(a){return this._authData=a,b.setItem("session.authData",JSON.stringify(a)),this},this.getAccessToken=function(){return this._authData&&this._authData.token?this._authData.token:null},this.destroy=function(){this.setAuthData(null)},this.getUserInfo=function(){return this._userInfo},this.setUserInfo=function(a){return this._userInfo=a,b.setItem("session.userInfo",JSON.stringify(a)),this}}function localStorageServiceFactory(a){if(a.localStorage)return a.localStorage;throw new Error("Local storage support is needed")}var app=angular.module("firebaseAngularApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.router","firebase","ui.bootstrap"]);app.constant("FIREBASE","https://testauthjuan.firebaseio.com/").config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("app",{url:"/app","abstract":!0,views:{header:{templateUrl:"views/layouts/header.html",controller:"HeaderCtrl",controllerAs:"vm"},footer:{templateUrl:"views/layouts/footer.html"}},params:{menus:{"app.home":{name:"Calendario",href:"#/app/"},"app.clientes":{name:"Clientes",href:"#/app/clientes"}}}}).state("app.home",{url:"/",views:{"@":{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"vm"}},params:{requireLogin:!0}}).state("root",{url:"","abstract":!0,views:{header:{templateUrl:"views/layouts/header.html"},footer:{templateUrl:"views/layouts/footer.html"}}}).state("root.login",{url:"/login",views:{"@":{templateUrl:"views/login.html",controller:"LoginCtrl",controllerAs:"vm"}},params:{requireLogin:!1}}).state("root.registro",{url:"/registro",views:{"@":{templateUrl:"views/registro.html",controller:"RegistroCtrl",controllerAs:"vm"}},params:{requireLogin:!1}}),b.otherwise("/app/")}]).run(["$rootScope","$location","$state","auth",function(a,b,c,d){a.$on("$stateChangeStart",function(a,b,e){e.requireLogin&&d.isLoggedIn()===!1&&(a.preventDefault(),c.go("root.login"))})}]),app.controller("MainCtrl",function(){}),app.controller("LoginCtrl",["$scope","auth","$state",function(a,b,c){var d=this;d.entrar=function(){if(console.log(a.user),a.user){var d=b.logIn(a.user);d.then(function(){c.go("app.home")})["catch"](function(a){console.error(a)})}}}]),app.controller("RegistroCtrl",["$scope","auth","$state","usuarios",function(a,b,c,d){var e=this;e.registrar=function(){if(a.user){var e=b.singIn(a.user);e.then(function(b){console.log(b);var e={nombre:a.user.nombre};d.registerUser(b.uid,e),c.go("app.home")})["catch"](function(a){console.log(a)})}}}]),app.controller("HeaderCtrl",["$scope","$stateParams","$state","session","auth",function(a,b,c,d,e){var f=this;angular.forEach(b.menus,function(a,d){c.current.name===d&&(a["class"]="active",b.menus[d]=a)}),a.menus=b.menus,e.isLoggedIn()&&(a.isLoggedIn=e.isLoggedIn(),a.user=d.getUserInfo(),f.salir=function(){e.logOut(),c.go("root.login")})}]),AuthService.$inject=["$q","$firebaseAuth","session","FIREBASE","usuarios"],app.service("auth",AuthService),sessionService.$inject=["$log","localStorage"],app.service("session",sessionService),localStorageServiceFactory.$inject=["$window"],app.factory("localStorage",localStorageServiceFactory),app.factory("usuarios",["$firebaseArray","FIREBASE",function(a,b){var c=new Firebase(b+"usuarios");return{registerUser:function(a,b){return console.log(a),c.child(a).set(b)},getUserInfo:function(b){var d=a(c);return d.$loaded().then(function(a){return console.log(a),console.log(a.$getRecord(b)),a.$getRecord(b)})}}}]),angular.module("firebaseAngularApp").run(["$templateCache",function(a){a.put("views/layouts/footer.html",'<div class="container"> <p><span class="glyphicon glyphicon-heart"></span> from the Yeoman team</p> </div>'),a.put("views/layouts/header.html",'<div class="navbar navbar-default" role="navigation"> <div class="container"> <div class="navbar-header"> <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#js-navbar-collapse"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="#/">ServiAgenda</a> </div> <div class="collapse navbar-collapse" id="js-navbar-collapse"> <!-- TODO: Hacer que se active el dropdown para mostrar acciones del usuario en session --> <ul class="nav navbar-nav"> <li class="{{menu.class}}" ng-repeat="menu in menus"> <a href="{{menu.href}}">{{menu.name}}</a> </li> </ul> <ul class="nav navbar-nav navbar-right" ng-if="isLoggedIn"> <li uib-dropdown> <a id="single-button" role="button" uib-dropdown-toggle> {{user.nombre}} <span class="caret"></span> </a> <ul class="dropdown-menu" uib-dropdown-menu role="menu" aria-labelledby="single-button"> <li role="menuitem"><a href="#" ng-click="vm.salir()">Cerrar Sesi√≥n</a></li> </ul> </li> </ul> </div> </div> </div>'),a.put("views/login.html",'<h1>Login</h1> <div class="well"> <form class="form-signin" role="form" ng-submit="vm.entrar()"> <input type="email" class="form-control" placeholder="Email" ng-model="user.email" required autofocus> <br> <input type="password" class="form-control" placeholder="Password" ng-model="user.password" required> <br> <input type="submit" class="btn btn-success" value="Entrar"> <a class="btn btn-default" ui-sref="root.registro">Registrarse</a> </form> </div>'),a.put("views/main.html",'<div class="jumbotron"> <h1>\'Allo, \'Allo!</h1> <p class="lead"> <img src="images/yeoman.8cb970fb.png" alt="I\'m Yeoman"><br> Always a pleasure scaffolding your apps. </p> <p> <a class="btn btn-lg btn-success"> Salir </a> </p> </div>'),a.put("views/registro.html",'<h1>Registro</h1> <div class="well"> <form class="form-signin" role="form" ng-submit="vm.registrar()"> <input type="text" class="form-control" placeholder="Nombre" ng-model="user.nombre" required> <br> <input type="email" class="form-control" placeholder="Email" ng-model="user.email" required autofocus> <br> <input type="password" class="form-control" placeholder="Clave" ng-model="user.password" required> <br> <input type="submit" class="btn btn-success" value="Registrarse"> <a class="btn btn-default" ui-sref="root.login">Cancelar</a> </form> </div>')}]);